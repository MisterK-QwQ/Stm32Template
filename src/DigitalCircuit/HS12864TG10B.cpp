#include "HS12864TG10B.hpp"
#include "../Manager/Manager.hpp"
#include "../Utils/Utils.hpp"
#include "stm32f1xx_hal.h"
const uint8_t HS12864TG10B::ascii8x8[] = {
    // 0x20 空格（无变化）
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x21 !（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x12→0x44）
    0x00,0x00,0x3E,0x44,0x3E,0x44,0x44,0x00,
    // 0x22 "（原0x12→0x44, 0x7C→0x3E, 0x12→0x44, 0x12→0x44）
    0x00,0x44,0x44,0x3E,0x44,0x44,0x00,0x00,
    // 0x23 #（原0x24→0x24, 0x2A→0x55, 0x7F→0xFE, 0x2A→0x55, 0x2A→0x55）
    0x00,0x24,0x55,0xFE,0x55,0x55,0x00,0x00,
    // 0x24 $（原0x23→0x8C, 0x25→0xA4, 0x0A→0x50, 0x11→0x88, 0x20→0x04, 0x7C→0x3E）
    0x00,0x8C,0xA4,0x50,0x88,0x04,0x3E,0x00,
    // 0x25 %（原0x62→0x46, 0x64→0x26, 0x08→0x10, 0x13→0x8C, 0x23→0x8C, 0x03→0xC0）
    0x00,0x46,0x26,0x10,0x8C,0x8C,0xC0,0x00,
    // 0x26 &（原0x36→0x6C, 0x49→0x92, 0x55→0xAA, 0x22→0x44, 0x50→0x0A）
    0x00,0x6C,0x92,0xAA,0x44,0x0A,0x00,0x00,
    // 0x27 '（原0x1C→0x38, 0x12→0x44, 0x7C→0x3E, 0x12→0x44, 0x12→0x44）
    0x00,0x00,0x38,0x44,0x3E,0x44,0x44,0x00,
    // 0x28 (（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x00,0x00,0x3E,0x44,0x44,0x3E,0x00,
    // 0x29 )（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x00,0x3E,0x44,0x44,0x3E,0x00,0x00,
    // 0x2A *（原0x12→0x44, 0x7F→0xFE, 0x7F→0xFE, 0x12→0x44, 0x7F→0xFE, 0x12→0x44）
    0x00,0x44,0xFE,0xFE,0x44,0xFE,0x44,0x00,
    // 0x2B +（原0x12→0x44, 0x7F→0xFE, 0x12→0x44, 0x12→0x44）
    0x00,0x00,0x44,0x44,0xFE,0x44,0x44,0x00,
    // 0x2C ,（原0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x00,0x00,0x00,0x44,0x44,0x3E,0x00,
    // 0x2D -（原0x12→0x44, 0x12→0x44, 0x12→0x44, 0x12→0x44, 0x12→0x44）
    0x00,0x00,0x44,0x44,0x44,0x44,0x44,0x00,
    // 0x2E .（原0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x00,0x00,0x00,0x44,0x44,0x3E,0x00,
    // 0x2F /（原0x02→0x40, 0x01→0x80, 0x01→0x80, 0x02→0x40, 0x04→0x20, 0x08→0x10）
    0x00,0x40,0x80,0x80,0x40,0x20,0x10,0x00,
    // 0x30 0（原0x3E→0x7C, 0x51→0x8A, 0x49→0x92, 0x45→0xA4, 0x3E→0x7C）
    0x00,0x7C,0x8A,0x92,0xA4,0x7C,0x00,0x00,
    // 0x31 1（原0x42→0x84, 0x7F→0xFE, 0x40→0x08）
    0x00,0x00,0x84,0xFE,0x08,0x00,0x00,0x00,
    // 0x32 2（原0x42→0x84, 0x61→0x8C, 0x51→0x8A, 0x49→0x92, 0x46→0x64）
    0x00,0x84,0x8C,0x8A,0x92,0x64,0x00,0x00,
    // 0x33 3（原0x21→0x84, 0x41→0x82, 0x45→0xA4, 0x4B→0xD2, 0x31→0x8C）
    0x00,0x84,0x82,0xA4,0xD2,0x8C,0x00,0x00,
    // 0x34 4（原0x18→0x18, 0x14→0x28, 0x12→0x44, 0x7F→0xFE, 0x10→0x08）
    0x00,0x18,0x28,0x44,0xFE,0x08,0x00,0x00,
    // 0x35 5（原0x27→0xE4, 0x45→0xA4, 0x45→0xA4, 0x45→0xA4, 0x39→0x9C）
    0x00,0xE4,0xA4,0xA4,0xA4,0x9C,0x00,0x00,
    // 0x36 6（原0x3C→0x3C, 0x4A→0x52, 0x49→0x92, 0x49→0x92, 0x30→0x0C）
    0x00,0x3C,0x52,0x92,0x92,0x0C,0x00,0x00,
    // 0x37 7（原0x01→0x80, 0x71→0x8E, 0x09→0x90, 0x05→0xA0, 0x03→0xC0）
    0x00,0x80,0x8E,0x90,0xA0,0xC0,0x00,0x00,
    // 0x38 8（原0x36→0x6C, 0x49→0x92, 0x49→0x92, 0x49→0x92, 0x36→0x6C）
    0x00,0x6C,0x92,0x92,0x92,0x6C,0x00,0x00,
    // 0x39 9（原0x06→0x60, 0x49→0x92, 0x49→0x92, 0x29→0x94, 0x1E→0x78）
    0x00,0x60,0x92,0x92,0x94,0x78,0x00,0x00,
    // 0x3A :（原0x36→0x6C, 0x36→0x6C）
    0x00,0x00,0x6C,0x6C,0x00,0x00,0x00,0x00,
    // 0x3B ;（原0x36→0x6C, 0x36→0x6C, 0x36→0x6C）
    0x00,0x00,0x6C,0x6C,0x00,0x6C,0x00,0x00,
    // 0x3C <（原0x08→0x10, 0x14→0x28, 0x22→0x44, 0x41→0x82）
    0x00,0x10,0x28,0x44,0x82,0x00,0x00,0x00,
    // 0x3D =（原0x24→0x24, 0x24→0x24, 0x24→0x24, 0x24→0x24, 0x24→0x24, 0x24→0x24）
    0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
    // 0x3E >（原0x41→0x82, 0x22→0x44, 0x14→0x28, 0x08→0x10）
    0x00,0x82,0x44,0x28,0x10,0x00,0x00,0x00,
    // 0x3F ?（原0x02→0x40, 0x01→0x80, 0x51→0x8A, 0x09→0x90, 0x06→0x60）
    0x00,0x40,0x80,0x8A,0x90,0x60,0x00,0x00,
    // 0x40 @（原0x3E→0x7C, 0x41→0x82, 0x5D→0xBA, 0x55→0xAA, 0x3E→0x7C）
    0x00,0x7C,0x82,0xBA,0xAA,0x7C,0x00,0x00,
    // 0x41 A（原0x7C→0x3E, 0x12→0x44, 0x11→0x88, 0x12→0x44, 0x7C→0x3E）
    0x00,0x3E,0x44,0x88,0x44,0x3E,0x00,0x00,
    // 0x42 B（原0x7F→0xFE, 0x49→0x92, 0x49→0x92, 0x49→0x92, 0x36→0x6C）
    0x00,0xFE,0x92,0x92,0x92,0x6C,0x00,0x00,
    // 0x43 C（原0x3E→0x7C, 0x41→0x82, 0x41→0x82, 0x41→0x82, 0x22→0x44）
    0x00,0x7C,0x82,0x82,0x82,0x44,0x00,0x00,
    // 0x44 D（原0x7F→0xFE, 0x41→0x82, 0x41→0x82, 0x22→0x44, 0x1C→0x38）
    0x00,0xFE,0x82,0x82,0x44,0x38,0x00,0x00,
    // 0x45 E（原0x7F→0xFE, 0x49→0x92, 0x49→0x92, 0x49→0x92, 0x41→0x82）
    0x00,0xFE,0x92,0x92,0x92,0x82,0x00,0x00,
    // 0x46 F（原0x7F→0xFE, 0x09→0x90, 0x09→0x90, 0x09→0x90, 0x01→0x80）
    0x00,0xFE,0x90,0x90,0x90,0x80,0x00,0x00,
    // 0x47 G（原0x3E→0x7C, 0x41→0x82, 0x49→0x92, 0x49→0x92, 0x3A→0x5C）
    0x00,0x7C,0x82,0x92,0x92,0x5C,0x00,0x00,
    // 0x48 H（原0x7F→0xFE, 0x08→0x10, 0x08→0x10, 0x08→0x10, 0x7F→0xFE）
    0x00,0xFE,0x10,0x10,0x10,0xFE,0x00,0x00,
    // 0x49 I（原0x41→0x82, 0x7F→0xFE, 0x41→0x82）
    0x00,0x00,0x82,0xFE,0x82,0x00,0x00,0x00,
    // 0x4A J（原0x20→0x04, 0x40→0x08, 0x41→0x82, 0x3F→0xFE, 0x01→0x80）
    0x00,0x04,0x08,0x82,0xFE,0x80,0x00,0x00,
    // 0x4B K（原0x7F→0xFE, 0x08→0x10, 0x14→0x28, 0x22→0x44, 0x41→0x82）
    0x00,0xFE,0x10,0x28,0x44,0x82,0x00,0x00,
    // 0x4C L（原0x7F→0xFE, 0x40→0x08, 0x40→0x08, 0x40→0x08, 0x40→0x08）
    0x00,0xFE,0x08,0x08,0x08,0x08,0x00,0x00,
    // 0x4D M（原0x7F→0xFE, 0x02→0x40, 0x0C→0x30, 0x02→0x40, 0x7F→0xFE）
    0x00,0xFE,0x40,0x30,0x40,0xFE,0x00,0x00,
    // 0x4E N（原0x7F→0xFE, 0x04→0x20, 0x08→0x10, 0x10→0x08, 0x7F→0xFE）
    0x00,0xFE,0x20,0x10,0x08,0xFE,0x00,0x00,
    // 0x4F O（原0x3E→0x7C, 0x41→0x82, 0x41→0x82, 0x41→0x82, 0x3E→0x7C）
    0x00,0x7C,0x82,0x82,0x82,0x7C,0x00,0x00,
    // 0x50 P（原0x7F→0xFE, 0x09→0x90, 0x09→0x90, 0x09→0x90, 0x06→0x60）
    0x00,0xFE,0x90,0x90,0x90,0x60,0x00,0x00,
    // 0x51 Q（原0x3E→0x7C, 0x41→0x82, 0x51→0x8A, 0x21→0x84, 0x5E→0x7A）
    0x00,0x7C,0x82,0x8A,0x84,0x7A,0x00,0x00,
    // 0x52 R（原0x7F→0xFE, 0x09→0x90, 0x19→0x98, 0x29→0x94, 0x46→0x64）
    0x00,0xFE,0x90,0x98,0x94,0x64,0x00,0x00,
    // 0x53 S（原0x46→0x64, 0x49→0x92, 0x49→0x92, 0x49→0x92, 0x31→0x8C）
    0x00,0x64,0x92,0x92,0x92,0x8C,0x00,0x00,
    // 0x54 T（原0x01→0x80, 0x01→0x80, 0x7F→0xFE, 0x01→0x80, 0x01→0x80）
    0x00,0x80,0x80,0xFE,0x80,0x80,0x00,0x00,
    // 0x55 U（原0x3F→0xFC, 0x40→0x08, 0x40→0x08, 0x40→0x08, 0x3F→0xFC）
    0x00,0xFC,0x08,0x08,0x08,0xFC,0x00,0x00,
    // 0x56 V（原0x1F→0xF8, 0x20→0x04, 0x40→0x08, 0x20→0x04, 0x1F→0xF8）
    0x00,0xF8,0x04,0x08,0x04,0xF8,0x00,0x00,
    // 0x57 W（原0x3F→0xFC, 0x40→0x08, 0x30→0x30, 0x40→0x08, 0x3F→0xFC）
    0x00,0xFC,0x08,0x30,0x08,0xFC,0x00,0x00,
    // 0x58 X（原0x63→0xC6, 0x14→0x28, 0x08→0x10, 0x14→0x28, 0x63→0xC6）
    0x00,0xC6,0x28,0x10,0x28,0xC6,0x00,0x00,
    // 0x59 Y（原0x07→0xE0, 0x08→0x10, 0x70→0x0E, 0x08→0x10, 0x07→0xE0）
    0x00,0xE0,0x10,0x0E,0x10,0xE0,0x00,0x00,
    // 0x5A Z（原0x61→0x86, 0x51→0x8A, 0x49→0x92, 0x45→0xA4, 0x43→0xC4）
    0x00,0x86,0x8A,0x92,0xA4,0xC4,0x00,0x00,
    // 0x5B [（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x3E,0x44,0x44,0x44,0x3E,0x00,0x00,
    // 0x5C \（原0x08→0x10, 0x04→0x20, 0x02→0x40, 0x01→0x80, 0x02→0x40, 0x04→0x20, 0x08→0x10）
    0x00,0x10,0x20,0x40,0x80,0x40,0x20,0x10,
    // 0x5D ]（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x3E,0x44,0x44,0x44,0x3E,0x00,0x00,
    // 0x5E ^（原0x02→0x40, 0x01→0x80, 0x01→0x80, 0x01→0x80, 0x02→0x40）
    0x00,0x40,0x80,0x80,0x80,0x40,0x00,0x00,
    // 0x5F _（原0x7F→0xFE）
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,
    // 0x60 `（原0x01→0x80, 0x02→0x40, 0x04→0x20, 0x08→0x10）
    0x00,0x80,0x40,0x20,0x10,0x00,0x00,0x00,
    // 0x61 a（原0x3E→0x7C, 0x41→0x82, 0x41→0x82, 0x41→0x82, 0x3E→0x7C）
    0x00,0x7C,0x82,0x82,0x82,0x7C,0x00,0x00,
    // 0x62 b（原0x7F→0xFE, 0x48→0x12, 0x48→0x12, 0x48→0x12, 0x30→0x0C）
    0x00,0xFE,0x12,0x12,0x12,0x0C,0x00,0x00,
    // 0x63 c（原0x38→0x1C, 0x44→0x22, 0x44→0x22, 0x44→0x22, 0x28→0x14）
    0x00,0x1C,0x22,0x22,0x22,0x14,0x00,0x00,
    // 0x64 d（原0x30→0x0C, 0x48→0x12, 0x48→0x12, 0x48→0x12, 0x7F→0xFE）
    0x00,0x0C,0x12,0x12,0x12,0xFE,0x00,0x00,
    // 0x65 e（原0x38→0x1C, 0x54→0x2A, 0x54→0x2A, 0x54→0x2A, 0x38→0x1C）
    0x00,0x1C,0x2A,0x2A,0x2A,0x1C,0x00,0x00,
    // 0x66 f（原0x08→0x10, 0x7E→0x7E, 0x09→0x90, 0x09→0x90, 0x00→0x00）
    0x00,0x10,0x7E,0x90,0x90,0x00,0x00,0x00,
    // 0x67 g（原0x0C→0x30, 0x52→0x4A, 0x52→0x4A, 0x52→0x4A, 0x3E→0x7C）
    0x00,0x30,0x4A,0x4A,0x4A,0x7C,0x00,0x00,
    // 0x68 h（原0x7F→0xFE, 0x08→0x10, 0x08→0x10, 0x08→0x10, 0x70→0x0E）
    0x00,0xFE,0x10,0x10,0x10,0x0E,0x00,0x00,
    // 0x69 i（原0x48→0x12, 0x7E→0x7E, 0x48→0x12）
    0x00,0x00,0x12,0x7E,0x12,0x00,0x00,0x00,
    // 0x6A j（原0x20→0x04, 0x40→0x08, 0x40→0x08, 0x3F→0xFE, 0x01→0x80）
    0x00,0x00,0x04,0x08,0x08,0xFE,0x80,0x00,
    // 0x6B k（原0x7F→0xFE, 0x10→0x08, 0x20→0x04, 0x40→0x02, 0x00→0x00）
    0x00,0xFE,0x08,0x04,0x02,0x00,0x00,0x00,
    // 0x6C l（原0x48→0x12, 0x48→0x12, 0x48→0x12, 0x7F→0xFE）
    0x00,0x00,0x12,0x12,0x12,0xFE,0x00,0x00,
    // 0x6D m（原0x3E→0x7C, 0x02→0x40, 0x0C→0x30, 0x02→0x40, 0x3E→0x7C）
    0x00,0x7C,0x40,0x30,0x40,0x7C,0x00,0x00,
    // 0x6E n（原0x3E→0x7C, 0x04→0x20, 0x04→0x20, 0x04→0x20, 0x3E→0x7C）
    0x00,0x7C,0x20,0x20,0x20,0x7C,0x00,0x00,
    // 0x6F o（原0x38→0x1C, 0x44→0x22, 0x44→0x22, 0x44→0x22, 0x38→0x1C）
    0x00,0x1C,0x22,0x22,0x22,0x1C,0x00,0x00,
    // 0x70 p（原0x7C→0x3E, 0x12→0x44, 0x12→0x44, 0x12→0x44, 0x0C→0x30）
    0x00,0x3E,0x44,0x44,0x44,0x30,0x00,0x00,
    // 0x71 q（原0x0C→0x30, 0x12→0x44, 0x12→0x44, 0x12→0x44, 0x7C→0x3E）
    0x00,0x30,0x44,0x44,0x44,0x3E,0x00,0x00,
    // 0x72 r（原0x3E→0x7C, 0x04→0x20, 0x04→0x20, 0x04→0x20, 0x08→0x10）
    0x00,0x7C,0x20,0x20,0x20,0x10,0x00,0x00,
    // 0x73 s（原0x08→0x10, 0x3E→0x7C, 0x44→0x22, 0x44→0x22, 0x38→0x1C）
    0x00,0x10,0x7C,0x22,0x22,0x1C,0x00,0x00,
    // 0x74 t（原0x04→0x20, 0x04→0x20, 0x3E→0x7C, 0x04→0x20, 0x04→0x20）
    0x00,0x20,0x20,0x7C,0x20,0x20,0x00,0x00,
    // 0x75 u（原0x3C→0x3C, 0x40→0x08, 0x40→0x08, 0x40→0x08, 0x3C→0x3C）
    0x00,0x3C,0x08,0x08,0x08,0x3C,0x00,0x00,
    // 0x76 v（原0x1C→0x38, 0x20→0x04, 0x40→0x08, 0x20→0x04, 0x1C→0x38）
    0x00,0x38,0x04,0x08,0x04,0x38,0x00,0x00,
    // 0x77 w（原0x3C→0x3C, 0x40→0x08, 0x30→0x30, 0x40→0x08, 0x3C→0x3C）
    0x00,0x3C,0x08,0x30,0x08,0x3C,0x00,0x00,
    // 0x78 x（原0x44→0x22, 0x28→0x14, 0x10→0x08, 0x28→0x14, 0x44→0x22）
    0x00,0x22,0x14,0x08,0x14,0x22,0x00,0x00,
    // 0x79 y（原0x0C→0x30, 0x50→0x0A, 0x50→0x0A, 0x50→0x0A, 0x3C→0x3C）
    0x00,0x30,0x0A,0x0A,0x0A,0x3C,0x00,0x00,
    // 0x7A z（原0x44→0x22, 0x64→0x26, 0x54→0x2A, 0x4C→0x34, 0x44→0x22）
    0x00,0x22,0x26,0x2A,0x34,0x22,0x00,0x00,
    // 0x7B {（原0x08→0x10, 0x14→0x28, 0x14→0x28, 0x08→0x10）
    0x00,0x00,0x10,0x28,0x28,0x10,0x00,0x00,
    // 0x7C |（原0x7C→0x3E, 0x7C→0x3E）
    0x00,0x00,0x00,0x3E,0x3E,0x00,0x00,0x00,
    // 0x7D }（原0x14→0x28, 0x08→0x10, 0x08→0x10, 0x14→0x28）
    0x00,0x00,0x28,0x10,0x10,0x28,0x00,0x00,
    // 0x7E ~（原0x08→0x10, 0x14→0x28, 0x22→0x44, 0x41→0x82, 0x22→0x44, 0x14→0x28, 0x08→0x10）
    0x00,0x10,0x28,0x44,0x82,0x44,0x28,0x10,
};

HS12864TG10B::HS12864TG10B(GPIO_TypeDef* scl_port, uint16_t scl_pin,
                           GPIO_TypeDef* sda_port, uint16_t sda_pin,
                           GPIO_TypeDef* a0_port,  uint16_t a0_pin,
                           GPIO_TypeDef* cs_port,  uint16_t cs_pin,
                           GPIO_TypeDef* res_port, uint16_t res_pin)
    : scl_port_(scl_port), scl_pin_(scl_pin),
      sda_port_(sda_port), sda_pin_(sda_pin),
      a0_port_(a0_port), a0_pin_(a0_pin),
      cs_port_(cs_port), cs_pin_(cs_pin),
      res_port_(res_port), res_pin_(res_pin) {}

      void HS12864TG10B::init() {
    if(!manager.initManager){
        return;
    }
    hardwareReset();
    HAL_Delay(10);
    writeCmd(0xE3);  // 软件复位
    HAL_Delay(20);
    writeCmd(0xF8);  // 4倍压
    writeCmd(0x00);  
    HAL_Delay(10);
    writeCmd(0x2F);  // 开启电源
    HAL_Delay(100);
    writeCmd(0xA3);  // 1/9bias
    writeCmd(0xA0);  // SEG方向：普通模式（正确）
    writeCmd(0xC0);  // COM方向：普通模式（正确）
    writeCmd(0x24);  // RR比率
    writeCmd(0x81);  // EV使能
    writeCmd(0x10);  
    writeCmd(0xA6);  // 关闭反显
    HAL_Delay(10);
    writeCmd(0xA4);  // 取消全亮
    clearScreen();  
    displayOn();
    HAL_Delay(50);
}

void HS12864TG10B::displayOn() {
    writeCmd(0xAF);
}
void HS12864TG10B::displayOff() {
    writeCmd(0xAE);
}

void HS12864TG10B::clearScreen() {
    memset(lcd_buffer, 0, sizeof(lcd_buffer));  // 清空缓冲区（1024字节）
    refreshScreen();  // 刷新LCD显示
}

void HS12864TG10B::turnOnAllPixel() {
    writeCmd(0xA5);
}

void HS12864TG10B::setInverseDisplay(bool enable) {
    if (enable) {
        writeCmd(0xA7);  // 反显指令（规格书9.1-9）
    } else {
        writeCmd(0xA6);  // 关闭反显（默认状态）
    }
}

uint8_t HS12864TG10B::reverseBit(uint8_t data) {
    return ((data & 0x01) << 7) | ((data & 0x02) << 5) | 
           ((data & 0x04) << 3) | ((data & 0x08) << 1) | 
           ((data & 0x10) >> 1) | ((data & 0x20) >> 3) | 
           ((data & 0x40) >> 5) | ((data & 0x80) >> 7);
}

void HS12864TG10B::writeCmd(uint8_t cmd) {
    HAL_GPIO_WritePin(cs_port_, cs_pin_, GPIO_PIN_RESET);  // 使能CS
    HAL_GPIO_WritePin(a0_port_, a0_pin_, GPIO_PIN_RESET);  // 指令模式（A0=0）
    for (uint8_t i = 0; i < 8; i++) {
        writeBit((cmd >> (7 - i)) & 0x01);  // 高位先传
    }
    HAL_GPIO_WritePin(cs_port_, cs_pin_, GPIO_PIN_SET);  // 禁用CS
}

void HS12864TG10B::writeBit(uint8_t bit) {
    HAL_GPIO_WritePin(sda_port_, sda_pin_, bit ? GPIO_PIN_SET : GPIO_PIN_RESET);
    Utils::HAL_Delay_us(1); 
    HAL_GPIO_WritePin(scl_port_, scl_pin_, GPIO_PIN_SET);
    Utils::HAL_Delay_us(1);
    HAL_GPIO_WritePin(scl_port_, scl_pin_, GPIO_PIN_RESET);
    Utils::HAL_Delay_us(1);
}

void HS12864TG10B::writeData(uint8_t dat) {
    HAL_GPIO_WritePin(cs_port_, cs_pin_, GPIO_PIN_RESET);  // 使能CS
    HAL_GPIO_WritePin(a0_port_, a0_pin_, GPIO_PIN_SET);    // 数据模式
    for (uint8_t i = 0; i < 8; i++) {
        writeBit((dat >> (7 - i)) & 0x01);  // 高位先传
    }
    HAL_GPIO_WritePin(cs_port_, cs_pin_, GPIO_PIN_SET);  // 禁用CS
}

void HS12864TG10B::hardwareReset() {
    HAL_GPIO_WritePin(res_port_, res_pin_, GPIO_PIN_RESET);
    HAL_Delay(10);  // 复位脉冲≥2us（留余）
    HAL_GPIO_WritePin(res_port_, res_pin_, GPIO_PIN_SET);
    HAL_Delay(50); // 复位后稳定时间
}

void HS12864TG10B::setCursor(uint8_t x, uint8_t y) {
    if (x >= LCD_WIDTH || y >= 8) return;  // 越界保护
    writeCmd(0xB0 + y);                  // 设置页地址（规格书9.1-3）
    writeCmd(0x10 + ((x >> 4) & 0x0F));  // 列地址高位（x的高4位）
    writeCmd(0x00 + (x & 0x0F));        // 列地址低位（x的低4位）
}

uint8_t HS12864TG10B::getPage(uint8_t y) {
    return y / 8;  // 每页8行，如y=9 → 页1
}

uint8_t HS12864TG10B::getPageOffset(uint8_t y) {
    return y % 8;  // 如y=9 → 偏移1（页1的第1行）
}

void HS12864TG10B::showAscii(uint8_t x, uint8_t y_page, char ch, uint8_t color) {
    if (x >= LCD_WIDTH || y_page >= LCD_PAGE || ch < 0x20 || ch > 0x7E) return;
    uint8_t char_index = (ch - 0x20) * 8;  // 正确字库索引
    for (uint8_t col = 7; col != 0xFF; col--) {  
        uint8_t curr_x = x + (7 - col);  // 列坐标：col7→x+0（左），col0→x+7（右）
        if (curr_x >= LCD_WIDTH) break;
        uint8_t char_data = ascii8x8[char_index + col];  // 反向取列数据（匹配字库）
        if (color == 0) char_data = ~char_data;  // 反色控制（默认不用）
        lcd_buffer[y_page][curr_x] = char_data;
    }
    
    refreshScreen();
}
void HS12864TG10B::showAsciiStr(uint8_t x_start, uint8_t y_page, const char* str, uint8_t color) {
    if (str == nullptr || x_start >= LCD_WIDTH || y_page >= LCD_PAGE) return;
    
    uint8_t curr_x = x_start; 
    for (uint8_t i = 0; str[i] != '\0'; i++) {
        if (curr_x + 8 > LCD_WIDTH) break;
        showAscii(curr_x, y_page, str[i], color);
        curr_x += 8;
    }
    refreshScreen();
}

void HS12864TG10B::refreshScreen() {
    // 原错误：page < LCD_HEIGHT（64），改为page < LCD_PAGE（8）
    for (uint8_t page = 0; page < LCD_PAGE; page++) {  
        setCursor(0, page);  // 定位到当前页第0列
        for (uint8_t x = 0; x < LCD_WIDTH; x++) {
            writeData(lcd_buffer[page][x]);  // 写入当前页所有列数据
        }
        Utils::HAL_Delay_us(50);
    }
}

void HS12864TG10B::drawPoint(uint8_t x, uint8_t y, uint8_t color) {
    if (x >= LCD_WIDTH || y >= LCD_HEIGHT) return;
    
    uint8_t page = getPage(y);          // 计算页（0~7）
    uint8_t offset = getPageOffset(y);  // 计算页内bit偏移（0~7）
    
    if (color == 1) {
        // 点亮：置位对应bit（不影响其他bit）
        lcd_buffer[page][x] |= (1 << offset);
    } else {
        // 熄灭：清0对应bit
        lcd_buffer[page][x] &= ~(1 << offset);
    }
}
// 新增：专用垂直直线绘制（x固定为50，y从y1到y2，避免setCursor计算偏差）
void HS12864TG10B::drawVerticalLine(uint8_t y1, uint8_t y2, uint8_t color) {
    const uint8_t fixed_x = 50;  // 固定x=50（垂直直线）
    if (y1 > y2) std::swap(y1, y2);  // 确保y1≤y2（避免反向遍历）
    
    // 遍历所有y值，修改缓冲区（fixed_x被使用，警告消失）
    for (uint8_t y = y1; y <= y2; y++) {
        drawPoint(fixed_x, y, color);  // 调用缓冲区画点
    }
    
    refreshScreen();  // 刷新LCD显示
}

void HS12864TG10B::drawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, uint8_t color) {
    int16_t dx = x2 - x1;  // x方向差值
    int16_t dy = y2 - y1;  // y方向差值
    int16_t sx = (dx > 0) ? 1 : (dx < 0) ? -1 : 0;  // x步长
    int16_t sy = (dy > 0) ? 1 : (dy < 0) ? -1 : 0;  // y步长
    dx = (dx < 0) ? -dx : dx;  // 取绝对值
    dy = (dy < 0) ? -dy : dy;
    
    int16_t err = dx - dy;
    int16_t x = x1, y = y1;
    
    while (1) {
        drawPoint(x, y, color);  // 调用修正后的drawPoint
        if (x == x2 && y == y2) break;  // 到达终点
        
        int16_t err2 = 2 * err;
        if (err2 > -dy) {  // x方向步进
            err -= dy;
            x += sx;
        }
        if (err2 < dx) {  // y方向步进
            err += dx;
            y += sy;
        }
    }
    refreshScreen();  // 绘制完成后刷新
}

void HS12864TG10B::drawTriangle(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, uint8_t x3, uint8_t y3, uint8_t color) {
    auto isCoordValid = [](uint8_t x, uint8_t y) {
        return (x < LCD_WIDTH) && (y < LCD_HEIGHT);
    };
    if (!isCoordValid(x1,y1) && !isCoordValid(x2,y2) && !isCoordValid(x3,y3)) return;
    drawLine(x1, y1, x2, y2, color);
    drawLine(x2, y2, x3, y3, color);
    drawLine(x3, y3, x1, y1, color);
}
void HS12864TG10B::drawRect(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, uint8_t color, bool fill) {
 
    if (x1 > x2) std::swap(x1, x2);  // 交换x，确保左上角x≤右下角x
    if (y1 > y2) std::swap(y1, y2);  // 交换y，确保左上角y≤右下角y
    x1 = (x1 < 0) ? 0 : x1;
    x2 = (x2 > 127) ? 127 : x2;
    y1 = (y1 < 0) ? 0 : y1;
    y2 = (y2 > 63) ? 63 : y2;

    if (fill) {
        for (uint8_t y = y1; y <= y2; y++) {  // 遍历y从y1到y2（垂直方向）
            for (uint8_t x = x1; x <= x2; x++) {  // 遍历x从x1到x2（水平方向）
                drawPoint(x, y, color);
            }
        }
    } 
    else {
        for (uint8_t x = x1; x <= x2; x++) {
            drawPoint(x, y1, color);
        }
        for (uint8_t x = x1; x <= x2; x++) {
            drawPoint(x, y2, color);
        }
        for (uint8_t y = y1 + 1; y < y2; y++) {
            drawPoint(x1, y, color);
        }
        for (uint8_t y = y1 + 1; y < y2; y++) {
            drawPoint(x2, y, color);
        }
    }

    refreshScreen();
}

void HS12864TG10B::drawCircle8Points(uint8_t x0, uint8_t y0, uint8_t x, uint8_t y, uint8_t color) {
    drawPoint(x0 + x, y0 + y, color);  // (x,y)
    drawPoint(x0 - x, y0 + y, color);  // (-x,y)
    drawPoint(x0 + x, y0 - y, color);  // (x,-y)
    drawPoint(x0 - x, y0 - y, color);  // (-x,-y)
    drawPoint(x0 + y, y0 + x, color);  // (y,x)
    drawPoint(x0 - y, y0 + x, color);  // (-y,x)
    drawPoint(x0 + y, y0 - x, color);  // (y,-x)
    drawPoint(x0 - y, y0 - x, color);  // (-y,-x)
}
void HS12864TG10B::drawCircle(uint8_t x0, uint8_t y0, uint8_t r, uint8_t color) {
    uint8_t dist_left = x0;                // 圆心到左边界（x=0）的距离
    uint8_t dist_right = 127 - x0;         // 圆心到右边界（x=127）的距离
    uint8_t dist_top = y0;                 // 圆心到上边界（y=0）的距离
    uint8_t dist_bottom = 63 - y0;         // 圆心到下边界（y=63）的距离
    
    uint8_t max_r = dist_left;
    if (dist_right < max_r) max_r = dist_right;
    if (dist_top < max_r) max_r = dist_top;
    if (dist_bottom < max_r) max_r = dist_bottom;
    
    if (r > max_r) r = max_r;
    if (r == 0) return;

    int16_t x = 0;                // 初始x坐标（从0开始）
    int16_t y = r;                // 初始y坐标（从半径开始）
    int16_t d = 3 - 2 * r;        // 初始误差值（中点判别式）

    while (x <= y) {
        drawCircle8Points(x0, y0, x, y, color);  // 绘制8个对称点
        
        if (d < 0) {
            d += 4 * x + 6;  // 中点在圆内，x+1，y不变
        } else {
            d += 4 * (x - y) + 10;  // 中点在圆外，x+1，y-1
            y--;
        }
        x++;  // x始终+1
    }

    refreshScreen();  // 刷新LCD
}